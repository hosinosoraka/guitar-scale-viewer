<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ギタースケール表示（Ver1.0）</title>
  <style>
    :root{
      /* Dark (default) palette */
      --bg:#0f1115; --panel:#171a21; --ink:#e6e6e6; --muted:#9aa4b2; --accent:#4f8cff;
      --board1:#1b222d; --board2:#121821; --nut:#e2e8f0; --fret:#293042; --string:#d1d7e1;
      --pos-border:#ffffff; /* ★ ダーク時はポジション縁を白 */
      --label-ink:#000000;  /* ラベル文字色（円内の文字） */

      /* Degree colors（両テーマで固定） */
      --deg-root:#3b82f6;   /* blue */
      --deg-third:#22c55e;  /* green */
      --deg-fifth:#ef4444;  /* red */
      --deg-seventh:#ec4899;/* pink */
      --deg-other:#32d296;  /* default */
      --deg-blues:#ffd166;  /* b5 */
    }
    /* Light theme palette（必要なら body に light クラスを手動付与で使用可） */
    body.light{
      --bg:#ffffff; --panel:#f6f7fb; --ink:#0f1115; --muted:#5b6778; --accent:#2d6bff;
      --board1:#f3f4f7; --board2:#e9ecf2; --nut:#aab3c7; --fret:#cfd6e4; --string:#9aa4b2;
      --pos-border:#0b0e14; /* ★ ライト時はポジション縁を黒 */
      --label-ink:#0b0e14;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height:1.5; display:flex; flex-direction:column; min-height:100vh;
    }
header{ padding:12px 16px; border-bottom:1px solid #232735; background:linear-gradient(180deg, rgba(21,24,35,.85), rgba(20,23,32,.85)); }
.toolbar{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); align-items:end; max-width:90vw; margin:0 auto; }
label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
select, button { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #2a2f40; background:var(--panel); color:var(--ink); outline:none; }
select:focus, button:focus { border-color: var(--accent); }
main{ padding:16px; display:grid; place-items:center; }
.card{ width:100%; max-width:90vw; background:var(--panel); border:1px solid #232735; border-radius:16px; padding:12px; }
canvas{ width:100%; height:360px; display:block; border-radius:12px; background:linear-gradient(180deg,var(--board1),var(--board2)); border:1px solid #1f2432; }
.legend{ display:flex; gap:16px; flex-wrap:wrap; font-size:12px; color:var(--muted); padding-top:8px; }
.chip{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; border:1px solid #2a2f40; background:var(--panel); }
.dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.foot { color:var(--muted); text-align:center; font-size:12px; margin-top:8px; }

  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <div>
        <label for="keySelect">キー</label>
        <select id="keySelect"></select>
      </div>
      <div>
        <label for="scaleSelect">スケール</label>
        <select id="scaleSelect"></select>
      </div>
      <div>
        <label for="labelMode">ラベル表示</label>
        <select id="labelMode">
          <option value="note">音名</option>
          <option value="degree">度数</option>
          <option value="both" selected>両方</option>
        </select>
      </div>
      <div>
        <label for="fretCount">フレット数（12〜24）</label>
        <select id="fretCount"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="resetHidden">非表示リセット</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <canvas id="fretboard" width="1400" height="520"></canvas>
      <div class="legend" id="legend"></div>
      <div class="foot">開放弦はナット左の丸。クリックでポジションの非表示/再表示ができます。</div>
    </div>
  </main>

  <script>
    /* ===== サイズをここで一括管理 ===== */
    const NOTE_RADIUS = 18;  // 音名/度数の丸（半径）
    const INLAY_R     = 5.5; // フレットインレイ（通常）
    const INLAY_R_12  = 6.5; // 12/24Fなどのダブルドット
    const LABEL_OFFSET_FACTOR = 0.42; // 両方表示の上下オフセット = NOTE_RADIUS * 係数

    // Notes & Scales (with degrees)
    const N_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const N_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
    const KEYS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

    const SCALES = {
      "Major (Ionian)": { intervals:[0,2,4,5,7,9,11], degrees:["1","9th","3","11th","5","13th","7"] },
      "Natural Minor":  { intervals:[0,2,3,5,7,8,10], degrees:["1","9th","m3","11th","5","m6","m7"] },
      "Major Pentatonic": { intervals:[0,2,4,7,9], degrees:["1","9th","3","5","13th"] },
      "Minor Pentatonic": { intervals:[0,3,5,7,10], degrees:["1","m3","11th","5","m7"] },
      "Blues": { intervals:[0,3,5,6,7,10], degrees:["1","m3","11th","b5","5","m7"] },
      "Dorian": { intervals:[0,2,3,5,7,9,10], degrees:["1","9th","m3","11th","5","13th","m7"] },
      "Phrygian": { intervals:[0,1,3,5,7,8,10], degrees:["1","b9th","m3","11th","5","m6","m7"] },
      "Lydian": { intervals:[0,2,4,6,7,9,11], degrees:["1","9th","3","#4","5","13th","7"] },
      "Mixolydian": { intervals:[0,2,4,5,7,9,10], degrees:["1","9th","3","11th","5","13th","m7"] },
      "Locrian": { intervals:[0,1,3,5,6,8,10], degrees:["1","b9th","m3","11th","b5","m6","m7"] },
      // Melodic Minor modes
      "Melodic Minor": { intervals:[0,2,3,5,7,9,11], degrees:["1","9th","m3","11th","5","13th","7"] },
      "Dorian b2": { intervals:[0,1,3,5,7,9,10], degrees:["1","b9th","m3","11th","5","13th","m7"] },
      "Lydian #5": { intervals:[0,2,4,6,8,9,11], degrees:["1","9th","3","#4","#5","13th","7"] },
      "Lydian b7": { intervals:[0,2,4,6,7,9,10], degrees:["1","9th","3","#4","5","13th","m7"] },
      "Mixolydian b6": { intervals:[0,2,4,5,7,8,10], degrees:["1","9th","3","11th","5","m6","m7"] },
      "Locrian #2": { intervals:[0,2,3,5,6,8,10], degrees:["1","9th","m3","11th","b5","m6","m7"] },
      "Altered (Super Locrian)": { intervals:[0,1,3,4,6,8,10], degrees:["1","b9th","m3","b4","b5","m6","m7"] },
      // Harmonic Minor modes
      "Harmonic Minor": { intervals:[0,2,3,5,7,8,11], degrees:["1","9th","m3","11th","5","m6","7"] },
      "Locrian #6": { intervals:[0,1,3,5,6,9,10], degrees:["1","b9th","m3","11th","b5","13th","m7"] },
      "Ionian #5": { intervals:[0,2,4,5,8,9,11], degrees:["1","9th","3","11th","#5","13th","7"] },
      "Dorian #4 (Ukrainian)": { intervals:[0,2,3,6,7,9,10], degrees:["1","9th","m3","#4","5","13th","m7"] },
      "Phrygian Dominant (Mixolydian b9 b13)": { intervals:[0,1,4,5,7,8,10], degrees:["1","b9th","3","11th","5","m6","m7"] },
      "Lydian #2": { intervals:[0,3,4,6,7,9,11], degrees:["1","#2","3","#4","5","13th","7"] },
      "Ultralocrian (Super Locrian bb7)": { intervals:[0,1,3,4,6,8,9], degrees:["1","b9th","m3","b4","b5","m6","bb7"] }
    };

    // Tuning: 1st(top) -> 6th(bottom)
    const TUNING = ["E","B","G","D","A","E"];

    // DOM
    const keySel = document.getElementById('keySelect');
    const scaleSel = document.getElementById('scaleSelect');
    const labelModeSel = document.getElementById('labelMode');
    const fretSel = document.getElementById('fretCount');
    const resetHidden = document.getElementById('resetHidden');
    const canvas = document.getElementById('fretboard');
    const ctx = canvas.getContext('2d');

    // Populate selects
    KEYS.forEach(k=>{ const o=document.createElement('option'); o.value=o.textContent=k; keySel.appendChild(o); });
    Object.keys(SCALES).forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; scaleSel.appendChild(o); });
    for (let f=12; f<=24; f++){ const o=document.createElement('option'); o.value=String(f); o.textContent=String(f); fretSel.appendChild(o); }

    // Defaults: C Major (Ionian), 16 frets
    keySel.value = 'C';
    scaleSel.value = 'Major (Ionian)';
    fretSel.value = '16';

    // Events
    ['input','change'].forEach(evt=> [keySel, scaleSel, fretSel, labelModeSel].forEach(el=> el.addEventListener(evt, draw)));
    let dpr = 1; function syncDPR(){ dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1)); }
    window.addEventListener('resize', ()=>{ syncDPR(); draw(); }); syncDPR();

    const hidden = new Set(); // "s:f"  (f=0 is open)

    const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    const preferFlat = key => ['F','Bb','Eb','Ab','Db','Gb','Cb'].includes(key);

    function buildScale(root, name){
      const {intervals, degrees} = SCALES[name];
      const pcs = new Set(intervals.map(i => (root + i) % 12));
      const degreeMap = new Map();
      intervals.forEach((i, idx)=>{
        degreeMap.set((root + i) % 12, degrees[idx]);
      });
      return {pcs, degreeMap};
    }

    function layout(strings, frets){
      const w = canvas.width / dpr, h = canvas.height / dpr;
      ctx.clearRect(0,0,w,h);
      const M = {left: 120, right: 24, top: 36, bottom: 56};
      const fbY = M.top;
      const fbH = h - M.top - M.bottom;
      const baseX = M.left;
      const fbW = w - baseX - M.right;

      // Board
      const boardX = 20, boardW = w - 40;
      const grd = ctx.createLinearGradient(0, fbY, 0, fbY + fbH);
      grd.addColorStop(0, css('--board1'));
      grd.addColorStop(1, css('--board2'));
      ctx.fillStyle = grd;
      roundRect(ctx, boardX, fbY, boardW, fbH, 16, true, true);

      // Nut
      ctx.fillStyle = css('--nut');
      ctx.fillRect(baseX - 10, fbY, 10, fbH);

      // Frets 1..N
      ctx.strokeStyle = css('--fret');
      ctx.lineWidth = 2;
      for(let f=1; f<=frets; f++){
        const x = baseX + fbW * (f / frets);
        ctx.beginPath(); ctx.moveTo(x, fbY); ctx.lineTo(x, fbY + fbH); ctx.stroke();
      }

      // Open center + cell width
      const cellW = fbW / frets;
      const openCx = baseX - cellW * 0.5;

      // Fret numbers bottom
      ctx.fillStyle = css('--muted');
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      const footY = fbY + fbH + 16;
      ctx.fillText('0', openCx, footY);
      for (let f=1; f<=frets; f++){
        const prevX = baseX + fbW * ((f-1)/frets);
        const thisX = baseX + fbW * (f/frets);
        const cx = (prevX + thisX) / 2;
        ctx.fillText(String(f), cx, footY);
      }

      // Position dots (inlays)
      ctx.fillStyle = '#3b80ff66';
      const dots = [3,5,7,9,12,15,17,19,21,24];
      dots.forEach(f=>{
        if (f>frets) return;
        const prevX = baseX + fbW * ((f-1)/frets);
        const thisX = baseX + fbW * (f/frets);
        const xCenter = (prevX + thisX) / 2;
        const is12 = f%12===0;
        if (is12){
          ctx.beginPath(); ctx.arc(xCenter, fbY+fbH*0.33, INLAY_R_12, 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(xCenter, fbY+fbH*0.66, INLAY_R_12, 0, Math.PI*2); ctx.fill();
        } else {
          ctx.beginPath(); ctx.arc(xCenter, fbY+fbH*0.5,  INLAY_R,    0, Math.PI*2); ctx.fill();
        }
      });

      // Strings
      for(let s=0; s<strings; s++){
        const y = fbY + fbH * (s+0.5)/strings;
        ctx.strokeStyle = css('--string');
        ctx.lineWidth = 1 + (strings - s)*0.4;
        ctx.beginPath(); ctx.moveTo(baseX, y); ctx.lineTo(baseX + fbW, y); ctx.stroke();
      }

      return {fbY, fbH, baseX, fbW, openCx};
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
      ctx.beginPath();
      ctx.moveTo(x + r.tl, y);
      ctx.lineTo(x + w - r.tr, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
      ctx.lineTo(x + w, y + h - r.br);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
      ctx.lineTo(x + r.bl, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
      ctx.lineTo(x, y + r.tl);
      ctx.quadraticCurveTo(x, y, x + r.tl, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function draw(){
      const frets = Math.max(12, Math.min(24, parseInt(fretSel.value||'16')));
      const strings = 6;
      const root = KEYS.indexOf(keySel.value);
      const scaleName = scaleSel.value;
      const labelMode = labelModeSel.value;

      // retina
      const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
      canvas.width = Math.floor(cssW * dpr); canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      const g = layout(strings, frets);
      const {pcs, degreeMap} = buildScale(root, scaleName);

      // notes (ポジションマーク本体)
      const r = NOTE_RADIUS;
      for(let s=0; s<strings; s++){
        const openPc = N_SHARP.indexOf(TUNING[s]);
        const cy = g.fbY + g.fbH * (s+0.5)/strings;

        // f=0 (open)
        const pc0 = openPc % 12;
        const key0 = `${s}:0`;
        if (!hidden.has(key0) && pcs.has(pc0)){
          drawNote(g.openCx, cy, r, pc0, root, degreeMap.get(pc0), labelMode, keySel.value);
        }

        // f=1..N at center of [f-1,f]
        for(let f=1; f<=frets; f++){
          const prevX = g.baseX + g.fbW * ((f-1)/frets);
          const thisX = g.baseX + g.fbW * (f/frets);
          const cx = (prevX + thisX)/2;
          const pc = (openPc + f) % 12;
          const key = `${s}:${f}`;
          if (!hidden.has(key) && pcs.has(pc)){
            drawNote(cx, cy, r, pc, root, degreeMap.get(pc), labelMode, keySel.value);
          }
        }
      }

      updateLegend();
    }

    function degreeColor(interval){
      if (interval === 0) return css('--deg-root');
      if (interval === 3 || interval === 4) return css('--deg-third');
      if (interval === 7) return css('--deg-fifth');
      if (interval === 10 || interval === 11) return css('--deg-seventh');
      if (interval === 6) return css('--deg-blues');
      return css('--deg-other');
    }

    function drawNote(cx, cy, r, pc, root, degreeText, mode, keyName){
      const interval = (pc - root + 12) % 12;
      const fill = degreeColor(interval);
      ctx.fillStyle = fill;
      ctx.strokeStyle = css('--pos-border');   // ★ ポジション縁色（テーマで切替）
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();

      // Labels
      const flats = ['F','Bb','Eb','Ab','Db','Gb','Cb'].includes(keyName);
      const noteName = (flats?N_FLAT:N_SHARP)[pc];

      ctx.fillStyle = css('--label-ink');      // 円内の文字色
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

      if (mode === 'note'){
        ctx.font = 'bold 12px system-ui';
        ctx.fillText(noteName, cx, cy);
      } else if (mode === 'degree'){
        ctx.font = 'bold 12px system-ui';
        ctx.fillText(degreeText || '', cx, cy);
      } else { // both
        const dy = r * LABEL_OFFSET_FACTOR; // 半径に比例して上下に配置
        ctx.font = 'bold 11px system-ui';
        ctx.fillText(degreeText || '', cx, cy - dy);
        ctx.font = 'bold 11px system-ui';
        ctx.fillText(noteName,       cx, cy + dy);
      }
    }

    // click to toggle (supports open = 0)
    canvas.addEventListener('click', (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      const y = ev.clientY - rect.top;
      const strings = 6;
      const frets = Math.max(12, Math.min(24, parseInt(fretSel.value||'16')));

      // layout recompute (cheap)
      const w = canvas.width / dpr, h = canvas.height / dpr;
      const M = {left: 120, right: 24, top: 36, bottom: 56};
      const fbY = M.top;
      const fbH = h - M.top - M.bottom;
      const baseX = M.left;            
      const fbW = w - baseX - M.right; 
      const cellW = fbW / frets;
      const openCx = baseX - cellW * 0.5;

      const sFloat = ((y - fbY) / fbH) * strings - 0.5;
      let s = Math.round(sFloat); s = Math.min(strings-1, Math.max(0, s));

      const centers = [openCx];
      for (let f=1; f<=frets; f++){
        const prevX = baseX + fbW * ((f-1)/frets);
        const thisX = baseX + fbW * (f/frets);
        centers.push( (prevX + thisX)/2 );
      }
      let nearestF = 0, best = Infinity;
      centers.forEach((cx, i) => { const d = Math.abs(cx - x); if (d < best){ best = d; nearestF = i; } });
      const key = `${s}:${nearestF}`;
      if (hidden.has(key)) hidden.delete(key); else hidden.add(key);
      draw();
    });

    // UI events
    document.getElementById('resetHidden').addEventListener('click', ()=>{ hidden.clear(); draw(); });

    function updateLegend(){
      const legend = document.getElementById('legend');
      legend.innerHTML = `
        <span class="chip"><span class="dot" style="background:var(--deg-root)"></span>ルート(1)</span>
        <span class="chip"><span class="dot" style="background:var(--deg-third)"></span>3度(m3/M3)</span>
        <span class="chip"><span class="dot" style="background:var(--deg-fifth)"></span>5度</span>
        <span class="chip"><span class="dot" style="background:var(--deg-seventh)"></span>7度(m7/M7)</span>
        <span class="chip"><span class="dot" style="background:var(--deg-other)"></span>その他スケール音</span>
        <span class="chip"><span class="dot" style="background:var(--deg-blues)"></span>ブルーノート</span>
        <span>キー: <b>${keySel.value}</b></span>
        <span>スケール: <b>${scaleSel.value}</b></span>
        <span>ラベル: <b>${labelModeSel.options[labelModeSel.selectedIndex].textContent}</b></span>
      `;
    }

    // Initial render (C Major, Dark default, Both labels)
    (function init(){
      updateLegend();
      draw();
    })();
  </script>
</body>
</html>
